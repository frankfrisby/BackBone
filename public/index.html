<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#f97316" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <title>BACKBONE AI</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #2b2b29;
      color: #e2e8f0;
      min-height: 100vh;
      padding: 0;
    }

    .container {
      max-width: 480px;
      width: 100%;
      margin: 0 auto;
      padding: 24px 16px;
      text-align: center;
    }

    .logo {
      font-size: 48px;
      font-weight: 800;
      color: #f97316;
      letter-spacing: 4px;
      margin-bottom: 8px;
    }

    .tagline {
      color: #94a3b8;
      font-size: 14px;
      margin-bottom: 40px;
    }

    .card {
      background: #3a3a37;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #4a4a45;
      text-align: left;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 700;
      color: #f97316;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card-count {
      font-size: 12px;
      color: #64748b;
    }

    /* User header card */
    .user-header {
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid #f97316;
      flex-shrink: 0;
    }

    .user-info { flex: 1; }

    .user-name {
      font-size: 16px;
      font-weight: 600;
      color: #b6b6ad;
    }

    .user-email {
      color: #94a3b8;
      font-size: 12px;
    }

    /* Status pills */
    .status-bar {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 99px;
      font-weight: 500;
    }

    .pill-green { background: #14532d; color: #86efac; }
    .pill-gray { background: #3b3b38; color: #9ca3af; }
    .pill-orange { background: #431407; color: #fdba74; }

    /* Thesis section */
    .thesis-text {
      font-size: 14px;
      line-height: 1.6;
      color: #cbd5e1;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }

    .section-title {
      font-size: 12px;
      font-weight: 700;
      color: #c6a56f;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .inline-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    /* List items */
    .list-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #4a4a45;
    }

    .list-item:last-child { border-bottom: none; }

    .item-progress {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      flex-shrink: 0;
      border: 2px solid;
    }

    .item-body { flex: 1; min-width: 0; }

    .item-title {
      font-size: 14px;
      font-weight: 500;
      color: #e2e8f0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-meta {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }

    .item-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    /* Project items */
    .project-item {
      padding: 8px 0;
      border-bottom: 1px solid #4a4a45;
    }

    .project-item:last-child { border-bottom: none; }

    .project-name {
      font-size: 14px;
      font-weight: 500;
      color: #e2e8f0;
    }

    .project-summary {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Backlog score bar */
    .score-bar {
      width: 36px;
      height: 4px;
      background: #2f2f2c;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }

    .score-fill {
      height: 100%;
      border-radius: 2px;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      margin-bottom: 12px;
    }

    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-primary { background: #f97316; color: #fff; }
    .btn-secondary { background: #3b3b38; color: #e2e8f0; }
    .btn-outline { background: transparent; color: #f97316; border: 1px solid #f97316; }
    .btn-sm { padding: 8px 16px; font-size: 13px; width: auto; margin: 0; }

    .hidden { display: none !important; }

    .msg {
      font-size: 13px;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 8px;
    }

    .msg-success { background: #14532d; color: #86efac; }
    .msg-error { background: #7f1d1d; color: #fca5a5; }
    .msg-info { background: #1e3a5f; color: #93c5fd; }

    .news-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .news-item {
      display: flex;
      gap: 10px;
      padding: 8px;
      border-radius: 12px;
      background: #2f2f2c;
      border: 1px solid #44443f;
      cursor: pointer;
    }

    .news-item:hover { border-color: #5a5a54; }

    .news-thumb {
      width: 64px;
      height: 64px;
      border-radius: 10px;
      object-fit: cover;
      background: #1f1f1d;
      flex-shrink: 0;
    }

    .news-title {
      font-size: 14px;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 4px;
    }

    .news-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .detail-view {
      position: fixed;
      inset: 0;
      background: rgba(25, 25, 23, 0.9);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
    }

    .detail-card {
      width: min(680px, 95vw);
      max-height: 90vh;
      overflow-y: auto;
      background: #2f2f2c;
      border-radius: 16px;
      border: 1px solid #4a4a45;
      padding: 16px;
      color: #e2e8f0;
    }

    .detail-hero {
      width: 100%;
      height: 180px;
      border-radius: 12px;
      object-fit: cover;
      margin-bottom: 12px;
      background: #1f1f1d;
    }

    .detail-body {
      font-size: 14px;
      line-height: 1.6;
      color: #d1d5db;
      white-space: pre-wrap;
    }

    .finance-card {
      background: #2f2f2c;
      border: 1px solid #4a4a45;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .finance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .finance-title {
      font-size: 14px;
      font-weight: 700;
      color: #e2e8f0;
    }

    .sparkline {
      width: 100%;
      height: 60px;
      margin-top: 8px;
    }

    .chip-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .chip {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #3b3b38;
      color: #cbd5e1;
    }

    .denied-title {
      font-size: 20px;
      font-weight: 700;
      color: #e2e8f0;
      margin-bottom: 8px;
    }

    .denied-text {
      color: #94a3b8;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .verifying-spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #2d2d5e;
      border-top-color: #f97316;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .footer {
      margin-top: 24px;
      padding-bottom: 24px;
      color: #475569;
      font-size: 12px;
      text-align: center;
    }

    .empty-state {
      color: #475569;
      font-size: 13px;
      padding: 12px 0;
      text-align: center;
    }

    .sync-time {
      font-size: 11px;
      color: #475569;
      text-align: right;
      margin-top: 4px;
    }

    .actions-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .actions-row .btn { flex: 1; }

    #view-signedout {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
  </style>
</head>
<body>
  <!-- Signed-out view -->
  <div id="view-signedout" class="container">
    <div class="logo">BACKBONE</div>
    <div class="tagline">Life Optimization Engine</div>
    <button id="btn-signin" class="btn btn-primary" onclick="signIn()">Sign in with Google</button>
    <div id="signin-msg"></div>
    <div class="footer">backboneai.web.app</div>
  </div>

  <!-- Verifying view -->
  <div id="view-verifying" class="container hidden">
    <div class="logo" style="font-size: 32px; margin-bottom: 24px;">BACKBONE</div>
    <div class="verifying-spinner"></div>
    <div style="color: #94a3b8; font-size: 14px;">Verifying your account...</div>
  </div>

  <!-- Access denied view -->
  <div id="view-denied" class="container hidden">
    <div class="logo" style="font-size: 32px; margin-bottom: 24px;">BACKBONE</div>
    <div class="card">
      <div class="denied-title">This app is not available</div>
      <div id="denied-reason" class="denied-text">
        You must first set up BACKBONE on your computer and complete phone verification before using this app.
      </div>
    </div>
    <button class="btn btn-outline" onclick="signOut()">Sign Out</button>
    <div class="footer">backboneai.web.app</div>
  </div>

  <!-- Dashboard view (verified user) -->
  <div id="view-signedin" class="container hidden">

    <!-- User header -->
    <div class="card">
      <div class="user-header">
        <img id="user-avatar" class="avatar" src="" alt="" />
        <div class="user-info">
          <div id="user-name" class="user-name"></div>
          <div id="user-email" class="user-email"></div>
          <div class="status-bar">
            <span id="notif-pill" class="pill pill-gray">Notifications off</span>
            <span id="device-pill" class="pill pill-gray">No device</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="actions-row">
      <button id="btn-notifications" class="btn btn-primary btn-sm" onclick="enableNotifications()">Enable Notifications</button>
      <button id="btn-install" class="btn btn-secondary btn-sm hidden" onclick="installApp()">Add to Home</button>
    </div>

    <!-- Market & Portfolio -->
    <div id="section-tickers" class="card hidden">
      <div class="card-header">
        <span class="card-title">Top Tickers</span>
        <span id="tickers-count" class="card-count"></span>
      </div>
      <div id="tickers-list"></div>
    </div>

    <div id="section-positions" class="card hidden">
      <div class="card-header">
        <span class="card-title">Positions</span>
        <span id="positions-count" class="card-count"></span>
      </div>
      <div id="positions-list"></div>
    </div>

    <div id="section-portfolio" class="card hidden">
      <div class="card-header">
        <span class="card-title">Portfolio</span>
        <span id="portfolio-meta" class="card-count"></span>
      </div>
      <div id="portfolio-body"></div>
    </div>

    <!-- Health -->
    <div id="section-health" class="card hidden">
      <div class="card-header">
        <span class="card-title">Health</span>
        <span id="health-meta" class="card-count"></span>
      </div>
      <div id="health-body"></div>
    </div>

    <!-- AI Status / Work -->
    <div id="section-work" class="card hidden">
      <div class="card-header">
        <span class="card-title">AI Work</span>
        <span id="work-meta" class="card-count"></span>
      </div>
      <div id="work-body"></div>
    </div>

    <!-- Chat -->
    <div id="section-chat" class="card hidden">
      <div class="card-header">
        <span class="card-title">Chat</span>
        <span class="card-count">Ask the AI</span>
      </div>
      <div id="chat-body"></div>
    </div>

    <!-- Dynamic Views -->
    <div id="section-dynamic" class="card hidden">
      <div class="card-header">
        <span class="card-title">Highlights</span>
        <span id="dynamic-count" class="card-count"></span>
      </div>
      <div id="dynamic-body"></div>
    </div>

    <!-- Thesis / Focus -->
    <div id="section-thesis" class="card hidden">
      <div class="card-header">
        <span class="card-title">Current Focus</span>
      </div>
      <div id="thesis-content" class="thesis-text"></div>
    </div>

    <!-- Goals -->
    <div id="section-goals" class="card hidden">
      <div class="card-header">
        <span class="card-title">Goals</span>
        <span id="goals-count" class="card-count"></span>
      </div>
      <div id="goals-list"></div>
    </div>

    <!-- Projects -->
    <div id="section-projects" class="card hidden">
      <div class="card-header">
        <span class="card-title">Projects</span>
        <span id="projects-count" class="card-count"></span>
      </div>
      <div id="projects-list"></div>
    </div>

    <!-- Backlog -->
    <div id="section-backlog" class="card hidden">
      <div class="card-header">
        <span class="card-title">Ideas Backlog</span>
        <span id="backlog-count" class="card-count"></span>
      </div>
      <div id="backlog-list"></div>
    </div>

    <div id="sync-time" class="sync-time"></div>
    <div id="action-msg"></div>
    <div id="detail-view" class="detail-view hidden">
      <div class="detail-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div id="detail-title" class="finance-title"></div>
          <button class="btn btn-secondary btn-sm" onclick="closeDetail()">Close</button>
        </div>
        <img id="detail-hero" class="detail-hero hidden" src="" alt="" />
        <div id="detail-meta" class="inline-meta" style="margin-bottom:10px;"></div>
        <div id="detail-body" class="detail-body"></div>
      </div>
    </div>

    <button class="btn btn-outline" style="margin-top: 12px;" onclick="signOut()">Sign Out</button>
    <div class="footer">backboneai.web.app</div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBKLqcnFQwNSKqHXgTBLok3l74ZmNh6_y0",
      authDomain: "backboneai.firebaseapp.com",
      projectId: "backboneai",
      storageBucket: "backboneai.firebasestorage.app",
      messagingSenderId: "338899630498",
      appId: "1:338899630498:web:ae0b9f35c498c88c8e498c"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let db = null;
    try {
      db = firebase.firestore();
    } catch (err) {
      console.warn("Firebase Firestore not available:", err);
    }
    let messaging = null;
    try {
      messaging = firebase.messaging();
    } catch (err) {
      console.warn("Firebase messaging not supported in this browser:", err);
    }
    const functions = firebase.functions();
    const storage = firebase.storage();

    let VAPID_KEY = null;
    let vapidKeyLoaded = false;

    let deferredInstallPrompt = null;
    let verifiedUser = false;
    let dashboardUnsub = null;

    // ── DOM refs ──────────────────────────────────────────────
    const $ = (id) => document.getElementById(id);
    const $signedOut    = $("view-signedout");
    const $verifying    = $("view-verifying");
    const $denied       = $("view-denied");
    const $signedIn     = $("view-signedin");
    const $btnSignIn    = $("btn-signin");
    const $btnNotif     = $("btn-notifications");
    const $btnInstall   = $("btn-install");
    const $signinMsg    = $("signin-msg");
    const $actionMsg    = $("action-msg");
    const $deniedReason = $("denied-reason");

    // ── Helpers ───────────────────────────────────────────────
    function hideAll() {
      $signedOut.classList.add("hidden");
      $verifying.classList.add("hidden");
      $denied.classList.add("hidden");
      $signedIn.classList.add("hidden");
    }

    function showMsg(el, text, type) {
      el.className = `msg msg-${type}`;
      el.textContent = text;
    }

    function categoryColor(cat) {
      const map = { finance: "#f59e0b", health: "#22c55e", career: "#3b82f6", learning: "#8b5cf6", personal: "#ec4899", growth: "#14b8a6", social: "#6366f1" };
      return map[cat] || "#64748b";
    }

    function scoreColor(score) {
      if (score >= 70) return "#22c55e";
      if (score >= 40) return "#f59e0b";
      return "#64748b";
    }

    async function loadVapidKey() {
      if (!db) return null;
      if (vapidKeyLoaded) return VAPID_KEY;
      vapidKeyLoaded = true;
      const docIds = ["config_fcm", "config_notifications", "config_web", "config_firebase"];
      for (const docId of docIds) {
        try {
          const snap = await db.collection("config").doc(docId).get();
          if (!snap.exists) continue;
          const data = snap.data() || {};
          const key = data.vapidKey
            || data.vapid_key
            || data.webPushVapidKey
            || data.web_push_vapid_key
            || data.fcmVapidKey
            || data.fcm_vapid_key;
          if (key && key !== "YOUR_VAPID_KEY_HERE") {
            VAPID_KEY = key;
            break;
          }
        } catch (err) {
          console.error("Failed to load VAPID key from", docId, err.message);
        }
      }
      return VAPID_KEY;
    }

    function relativeTime(dateStr) {
      if (!dateStr) return "";
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      const days = Math.floor(hrs / 24);
      return `${days}d ago`;
    }

    // ── User verification ─────────────────────────────────────
    async function verifyBackboneUser(user) {
      if (!db) return { allowed: false, reason: "error" };
      try {
        const doc = await db.collection("users").doc(user.uid).get();
        if (!doc.exists) return { allowed: false, reason: "no-account" };
        const data = doc.data();
        if (!data.whatsappPhone) return { allowed: false, reason: "no-phone" };
        if (!data.whatsappPhone.startsWith("+1") || data.whatsappPhone.length < 11) return { allowed: false, reason: "not-usa" };
        if (data.source && data.source !== "backbone-cli") return { allowed: false, reason: "no-account" };
        return { allowed: true };
      } catch (err) {
        console.error("Verify error:", err);
        return { allowed: false, reason: "error" };
      }
    }

    function showDenied(reason) {
      const msgs = {
        "no-account": "You must first set up BACKBONE on your computer before using this app. Sign in through the BACKBONE CLI to create your account.",
        "no-phone": "Phone verification required. Complete WhatsApp verification in the BACKBONE CLI before using this app.",
        "not-usa": "This app is currently available to US users only.",
        "error": "Could not verify your account. Please try again later."
      };
      $deniedReason.textContent = msgs[reason] || msgs["error"];
      hideAll();
      $denied.classList.remove("hidden");
    }

    // ── Auth ──────────────────────────────────────────────────
    auth.onAuthStateChanged(async (user) => {
      if (dashboardUnsub) { dashboardUnsub(); dashboardUnsub = null; }

      if (!user) {
        verifiedUser = false;
        hideAll();
        $signedOut.classList.remove("hidden");
        return;
      }

      hideAll();
      $verifying.classList.remove("hidden");

      const result = await verifyBackboneUser(user);
      if (!result.allowed) {
        verifiedUser = false;
        await auth.signOut();
        showDenied(result.reason);
        return;
      }

      verifiedUser = true;
      showDashboard(user);
    });

    auth.getRedirectResult().catch((err) => {
      showMsg($signinMsg, "Sign-in failed: " + err.message, "error");
      $btnSignIn.disabled = false;
      $btnSignIn.textContent = "Sign in with Google";
    });

    document.addEventListener("DOMContentLoaded", () => {
      if ($btnSignIn) {
        $btnSignIn.addEventListener("click", () => signIn());
      }
    });

    window.signIn = signIn;
    window.signOut = signOut;

    function showDashboard(user) {
      if (!db) {
        showDenied("error");
        return;
      }
      hideAll();
      $signedIn.classList.remove("hidden");
      $("user-avatar").src = user.photoURL || "/icons/icon-192.png";
      $("user-name").textContent = user.displayName || "BACKBONE User";
      $("user-email").textContent = user.email || "";

      loadVapidKey().then((key) => {
        if (!key && Notification.permission !== "granted") {
          $btnNotif.textContent = "Notifications Unavailable";
        }
      });

      if (Notification.permission === "granted") {
        $("notif-pill").className = "pill pill-green";
        $("notif-pill").textContent = "Notifications on";
        $btnNotif.textContent = "Notifications On";
        $btnNotif.disabled = true;
        registerToken();
      }

      // Subscribe to real-time dashboard updates
      dashboardUnsub = db.collection("users").doc(user.uid)
        .collection("app").doc("dashboard")
        .onSnapshot((snap) => {
          if (snap.exists) {
            renderDashboard(snap.data());
          } else {
            $("section-tickers").classList.add("hidden");
            $("section-positions").classList.add("hidden");
            $("section-portfolio").classList.add("hidden");
            $("section-health").classList.add("hidden");
            $("section-work").classList.add("hidden");
            $("section-chat").classList.add("hidden");
            $("section-dynamic").classList.add("hidden");
            $("section-thesis").classList.add("hidden");
            $("section-goals").classList.add("hidden");
            $("section-projects").classList.add("hidden");
            $("section-backlog").classList.add("hidden");
            $("sync-time").textContent = "No data synced yet. Run /sync firebase in BACKBONE CLI.";
          }
        }, (err) => {
          console.error("Dashboard listen error:", err);
        });
    }

    // ── Render dashboard ──────────────────────────────────────
    function renderDashboard(data) {
      renderTickers(data.tickers || data.topTickers || []);
      renderPositions(data.positions || []);
      renderPortfolio(data.portfolio || data.portfolioSummary || null);
      renderHealth(data.health || data.oura || null);
      renderWork(data.work || data.aiWork || null);
      renderChat(data.chat || data.conversation || null);
      renderDynamicViews(data.dynamicViews || data.views || data.contentBlocks || []);

      // Thesis
      if (data.thesis) {
        $("section-thesis").classList.remove("hidden");
        // Show first meaningful section (skip header lines)
        const lines = data.thesis.split("\n");
        let start = 0;
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("## ") && !lines[i].includes("Current Thesis")) {
            start = i;
            break;
          }
        }
        const excerpt = lines.slice(start, start + 12).join("\n").trim();
        $("thesis-content").textContent = excerpt || lines.slice(0, 10).join("\n").trim();
      } else {
        $("section-thesis").classList.add("hidden");
      }

      // Goals
      const goals = data.goals || [];
      if (goals.length > 0) {
        $("section-goals").classList.remove("hidden");
        $("goals-count").textContent = `${goals.length}`;
        const activeGoals = goals.filter(g => g.status !== "completed").slice(0, 8);
        const completedGoals = goals.filter(g => g.status === "completed").slice(0, 3);
        const displayGoals = [...activeGoals, ...completedGoals];

        $("goals-list").innerHTML = displayGoals.map(g => {
          const pct = g.progress || 0;
          const color = g.status === "completed" ? "#22c55e" : categoryColor(g.category);
          const borderColor = g.status === "completed" ? "#22c55e" : color;
          return `
            <div class="list-item">
              <div class="item-progress" style="border-color: ${borderColor}; color: ${borderColor};">
                ${g.status === "completed" ? "&#10003;" : pct + "%"}
              </div>
              <div class="item-body">
                <div class="item-title">${esc(g.title)}</div>
                <div class="item-meta">
                  <span class="item-badge" style="background:${color}22; color:${color}">${esc(g.category)}</span>
                  ${g.updatedAt ? ' · ' + relativeTime(g.updatedAt) : ''}
                </div>
              </div>
            </div>`;
        }).join("");
      } else {
        $("section-goals").classList.add("hidden");
      }

      // Projects
      const projects = data.projects || [];
      if (projects.length > 0) {
        $("section-projects").classList.remove("hidden");
        $("projects-count").textContent = `${projects.length}`;
        $("projects-list").innerHTML = projects.slice(0, 10).map(p => `
          <div class="project-item">
            <div class="project-name">${esc(p.title)}</div>
            ${p.summary ? `<div class="project-summary">${esc(p.summary)}</div>` : ''}
          </div>`).join("");
      } else {
        $("section-projects").classList.add("hidden");
      }

      // Backlog
      const backlog = data.backlog || [];
      if (backlog.length > 0) {
        $("section-backlog").classList.remove("hidden");
        $("backlog-count").textContent = `${data.backlogCount || backlog.length}`;
        $("backlog-list").innerHTML = backlog.slice(0, 10).map(item => {
          const sc = item.impactScore || 0;
          const clr = scoreColor(sc);
          return `
            <div class="list-item">
              <div class="item-progress" style="border-color: ${clr}; color: ${clr}; font-size: 10px;">
                ${sc}
              </div>
              <div class="item-body">
                <div class="item-title">${esc(item.title)}</div>
                <div class="item-meta">
                  <span class="item-badge" style="background:${categoryColor(item.category)}22; color:${categoryColor(item.category)}">${esc(item.category)}</span>
                  · ${esc(item.source || '')}
                </div>
              </div>
            </div>`;
        }).join("");
      } else {
        $("section-backlog").classList.add("hidden");
      }

      // Sync time
      if (data.updatedAt) {
        $("sync-time").textContent = "Last synced: " + relativeTime(data.updatedAt);
      }
    }

    function esc(s) {
      if (!s) return "";
      const d = document.createElement("div");
      d.textContent = s;
      return d.innerHTML;
    }

    function toNumber(n) {
      const v = typeof n === "string" ? parseFloat(n) : n;
      return Number.isFinite(v) ? v : null;
    }

    function formatMoney(n) {
      const v = toNumber(n);
      if (v === null) return "";
      return v.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 2 });
    }

    function formatPct(n) {
      const v = toNumber(n);
      if (v === null) return "";
      const sign = v > 0 ? "+" : "";
      return `${sign}${v.toFixed(2)}%`;
    }

    function sparklinePath(points, w = 260, h = 60) {
      if (!Array.isArray(points) || points.length < 2) return "";
      const vals = points.map(p => toNumber(p)).filter(v => v !== null);
      if (vals.length < 2) return "";
      const min = Math.min(...vals);
      const max = Math.max(...vals);
      const span = max - min || 1;
      const dx = w / (vals.length - 1);
      return vals.map((v, i) => {
        const x = i * dx;
        const y = h - ((v - min) / span) * h;
        return `${i === 0 ? "M" : "L"}${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(" ");
    }

    function markdownToHtml(md) {
      if (!md) return "";
      const safe = esc(md);
      return safe
        .replace(/^### (.*)$/gm, "<h3>$1</h3>")
        .replace(/^## (.*)$/gm, "<h2>$1</h2>")
        .replace(/^# (.*)$/gm, "<h1>$1</h1>")
        .replace(/\\*\\*(.*?)\\*\\*/g, "<strong>$1</strong>")
        .replace(/\\*(.*?)\\*/g, "<em>$1</em>")
        .replace(/^\\- (.*)$/gm, "<li>$1</li>")
        .replace(/(<li>.*<\\/li>)/gs, "<ul>$1</ul>")
        .replace(/\\n/g, "<br />");
    }

    function renderTickers(tickers) {
      if (!Array.isArray(tickers) || tickers.length === 0) {
        $("section-tickers").classList.add("hidden");
        return;
      }
      $("section-tickers").classList.remove("hidden");
      $("tickers-count").textContent = `${tickers.length}`;
      $("tickers-list").innerHTML = tickers.slice(0, 5).map(t => {
        const change = toNumber(t.changePct);
        const changeColor = change > 0 ? "#22c55e" : change < 0 ? "#f59e0b" : "#9ca3af";
        return `
          <div class="list-item">
            <div class="item-body">
              <div class="item-title">${esc(t.symbol || t.ticker || "")} · ${formatMoney(t.price) || ""}</div>
              <div class="item-meta" style="color:${changeColor}">
                ${formatPct(change)} ${esc(t.name || "")}
              </div>
            </div>
          </div>`;
      }).join("");
    }

    function renderPositions(positions) {
      if (!Array.isArray(positions) || positions.length === 0) {
        $("section-positions").classList.add("hidden");
        return;
      }
      $("section-positions").classList.remove("hidden");
      $("positions-count").textContent = `${positions.length}`;
      $("positions-list").innerHTML = positions.slice(0, 6).map(p => {
        const pnl = toNumber(p.unrealizedPnl || p.pnl);
        const pnlColor = pnl > 0 ? "#22c55e" : pnl < 0 ? "#f59e0b" : "#9ca3af";
        return `
          <div class="list-item">
            <div class="item-body">
              <div class="item-title">${esc(p.symbol || "")} · ${formatMoney(p.marketValue || p.value) || ""}</div>
              <div class="item-meta" style="color:${pnlColor}">
                ${formatMoney(pnl)} (${formatPct(p.pnlPct)})
              </div>
            </div>
          </div>`;
      }).join("");
    }

    function renderPortfolio(portfolio) {
      if (!portfolio) {
        $("section-portfolio").classList.add("hidden");
        return;
      }
      $("section-portfolio").classList.remove("hidden");
      $("portfolio-meta").textContent = portfolio.updatedAt ? relativeTime(portfolio.updatedAt) : "";
      const points = portfolio.equityCurve || portfolio.history || [];
      const path = sparklinePath(points);
      $("portfolio-body").innerHTML = `
        <div class="finance-card">
          <div class="finance-header">
            <div class="finance-title">${formatMoney(portfolio.totalValue || portfolio.equity)}</div>
            <div class="inline-meta" style="color:${(portfolio.dayChangePct || 0) >= 0 ? "#22c55e" : "#f59e0b"}">
              ${formatMoney(portfolio.dayChange)} ${formatPct(portfolio.dayChangePct)}
            </div>
          </div>
          ${path ? `<svg class="sparkline" viewBox="0 0 260 60" preserveAspectRatio="none">
            <path d="${path}" fill="none" stroke="#f97316" stroke-width="2" />
          </svg>` : `<div class="inline-meta">No chart data</div>`}
          <div class="chip-row">
            ${portfolio.cash !== undefined ? `<span class="chip">Cash ${formatMoney(portfolio.cash)}</span>` : ""}
            ${portfolio.buyingPower !== undefined ? `<span class="chip">Buying ${formatMoney(portfolio.buyingPower)}</span>` : ""}
            ${portfolio.risk ? `<span class="chip">Risk ${esc(portfolio.risk)}</span>` : ""}
          </div>
        </div>`;
    }

    function renderHealth(health) {
      if (!health) {
        $("section-health").classList.add("hidden");
        return;
      }
      $("section-health").classList.remove("hidden");
      $("health-meta").textContent = health.updatedAt ? relativeTime(health.updatedAt) : "";
      const items = [
        health.readiness ? `Readiness ${health.readiness}` : null,
        health.sleepScore ? `Sleep ${health.sleepScore}` : null,
        health.activityScore ? `Activity ${health.activityScore}` : null,
        health.steps ? `Steps ${health.steps}` : null
      ].filter(Boolean);
      $("health-body").innerHTML = items.length
        ? items.map(i => `<div class="list-item"><div class="item-body"><div class="item-title">${esc(i)}</div></div></div>`).join("")
        : `<div class="empty-state">No health data yet.</div>`;
    }

    function renderWork(work) {
      if (!work) {
        $("section-work").classList.add("hidden");
        return;
      }
      $("section-work").classList.remove("hidden");
      $("work-meta").textContent = work.status || "";
      const tasks = Array.isArray(work.tasks) ? work.tasks : [];
      $("work-body").innerHTML = tasks.length
        ? tasks.slice(0, 6).map(t => `
          <div class="list-item">
            <div class="item-body">
              <div class="item-title">${esc(t.title || t.name || "")}</div>
              <div class="item-meta">${esc(t.state || t.status || "")}</div>
            </div>
          </div>`).join("")
        : `<div class="empty-state">AI is idle.</div>`;
    }

    function renderChat(chat) {
      if (!chat) {
        $("section-chat").classList.add("hidden");
        return;
      }
      $("section-chat").classList.remove("hidden");
      const prompts = Array.isArray(chat.prompts) ? chat.prompts : [];
      const last = chat.lastMessage || chat.latest || null;
      $("chat-body").innerHTML = `
        ${last ? `<div class="list-item"><div class="item-body"><div class="item-title">${esc(last.from || "AI")}</div><div class="item-meta">${esc(last.text || "")}</div></div></div>` : ""}
        ${prompts.length ? prompts.slice(0, 3).map(p => `<div class="chip">${esc(p)}</div>`).join("") : ""}
        <div class="inline-meta" style="margin-top:8px;">Use WhatsApp or the CLI to chat.</div>
      `;
    }

    const detailStore = new Map();
    const markdownCache = new Map();

    function normalizeStorageRef(value) {
      if (!value) return null;
      if (value.startsWith("gs://") || value.startsWith("https://")) {
        return { type: "url", value };
      }
      return { type: "path", value };
    }

    async function loadMarkdownFromStorage(refValue) {
      const refInfo = normalizeStorageRef(refValue);
      if (!refInfo) return null;
      const cacheKey = `${refInfo.type}:${refInfo.value}`;
      if (markdownCache.has(cacheKey)) return markdownCache.get(cacheKey);
      try {
        const ref = refInfo.type === "url"
          ? storage.refFromURL(refInfo.value)
          : storage.ref(refInfo.value);
        const url = await ref.getDownloadURL();
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        markdownCache.set(cacheKey, text);
        return text;
      } catch (err) {
        console.error("Failed to load markdown:", err.message);
        return null;
      }
    }

    async function hydrateViewContent(view) {
      if (!view || view.content || view.body || view.summary || view.markdown) return view;
      const ref = view.storagePath || view.storageUrl || view.mdPath || view.mdUrl;
      if (!ref) return view;
      const text = await loadMarkdownFromStorage(ref);
      if (text) {
        view.markdown = text;
      }
      return view;
    }

    async function openDetailById(id) {
      let view = detailStore.get(id);
      if (!view) return;
      $("detail-title").textContent = view.title || view.headline || "Detail";
      $("detail-meta").textContent = [view.source, view.publishedAt, view.symbol].filter(Boolean).join(" · ");
      const hero = $("detail-hero");
      if (view.image || view.imageUrl) {
        hero.src = view.image || view.imageUrl;
        hero.classList.remove("hidden");
      } else {
        hero.classList.add("hidden");
      }
      const bodyEl = $("detail-body");
      bodyEl.textContent = "Loading...";
      view = await hydrateViewContent(view);
      const content = view.content || view.body || view.summary || view.markdown || "";
      bodyEl.innerHTML = view.markdown ? markdownToHtml(content) : esc(content).replace(/\\n/g, "<br />");
      $("detail-view").classList.remove("hidden");
    }

    function closeDetail() {
      $("detail-view").classList.add("hidden");
    }

    function renderDynamicViews(views) {
      if (!Array.isArray(views) || views.length === 0) {
        $("section-dynamic").classList.add("hidden");
        return;
      }
      $("section-dynamic").classList.remove("hidden");
      $("dynamic-count").textContent = `${views.length}`;
      detailStore.clear();
      const container = $("dynamic-body");
      container.innerHTML = "";

      views.forEach((v, idx) => {
        const type = (v.type || v.kind || "generic").toLowerCase();
        if (type === "news_list" || type === "news") {
          const title = document.createElement("div");
          title.className = "section-title";
          title.textContent = v.title || "News";
          container.appendChild(title);

          const list = document.createElement("div");
          list.className = "news-list";
          (v.items || []).slice(0, 5).forEach((item, j) => {
            const id = `news_${idx}_${j}`;
            detailStore.set(id, item);
            const node = document.createElement("div");
            node.className = "news-item";
            node.setAttribute("data-view-id", id);
            node.innerHTML = `
              <img class="news-thumb" src="${esc(item.image || item.imageUrl || "")}" alt="" onerror="this.style.display='none'" />
              <div>
                <div class="news-title">${esc(item.title || "")}</div>
                <div class="news-meta">${esc(item.source || "")} · ${esc(item.publishedAt || "")}</div>
              </div>`;
            list.appendChild(node);
          });
          container.appendChild(list);
          return;
        }

        if (type === "finance_robinhood" || type === "portfolio") {
          const p = v.portfolio || v.data || {};
          const points = p.equityCurve || p.history || [];
          const path = sparklinePath(points);
          const node = document.createElement("div");
          node.className = "finance-card";
          node.innerHTML = `
            <div class="finance-header">
              <div class="finance-title">${esc(v.title || "Portfolio")}</div>
              <div class="inline-meta">${formatMoney(p.totalValue || p.equity)}</div>
            </div>
            ${path ? `<svg class="sparkline" viewBox="0 0 260 60" preserveAspectRatio="none">
              <path d="${path}" fill="none" stroke="#f97316" stroke-width="2" />
            </svg>` : `<div class="inline-meta">No chart data</div>`}
            <div class="chip-row">
              ${p.dayChange !== undefined ? `<span class="chip">${formatMoney(p.dayChange)} ${formatPct(p.dayChangePct)}</span>` : ""}
              ${p.cash !== undefined ? `<span class="chip">Cash ${formatMoney(p.cash)}</span>` : ""}
            </div>`;
          container.appendChild(node);
          return;
        }

        if (type === "markdown" || type === "md") {
          const title = document.createElement("div");
          title.className = "section-title";
          title.textContent = v.title || "Notes";
          container.appendChild(title);
          const body = document.createElement("div");
          body.className = "detail-body";
          const text = v.markdown || v.content || "";
          body.innerHTML = markdownToHtml(text) || "<div class=\"inline-meta\">Loading...</div>";
          container.appendChild(body);
          if (!text && (v.storagePath || v.storageUrl || v.mdPath || v.mdUrl)) {
            hydrateViewContent(v).then((hydrated) => {
              const nextText = hydrated.markdown || hydrated.content || "";
              body.innerHTML = markdownToHtml(nextText) || "<div class=\"inline-meta\">No content.</div>";
            });
          }
          return;
        }

        if (type === "news_article") {
          const id = `article_${idx}`;
          detailStore.set(id, v);
          const node = document.createElement("div");
          node.className = "news-item";
          node.setAttribute("data-view-id", id);
          node.innerHTML = `
            <img class="news-thumb" src="${esc(v.image || v.imageUrl || "")}" alt="" onerror="this.style.display='none'" />
            <div>
              <div class="news-title">${esc(v.title || "")}</div>
              <div class="news-meta">${esc(v.source || "")} · ${esc(v.publishedAt || "")}</div>
            </div>`;
          container.appendChild(node);
          return;
        }

        const generic = document.createElement("div");
        generic.className = "list-item";
        generic.innerHTML = `
          <div class="item-body">
            <div class="item-title">${esc(v.title || "Update")}</div>
            <div class="item-meta">${esc(v.summary || v.subtitle || "")}</div>
          </div>`;
        container.appendChild(generic);
      });

      container.querySelectorAll("[data-view-id]").forEach(node => {
        node.addEventListener("click", () => openDetailById(node.getAttribute("data-view-id")));
      });
    }

    // ── Sign in / out ─────────────────────────────────────────
    async function signIn() {
      $btnSignIn.disabled = true;
      $btnSignIn.textContent = "Signing in...";
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch (err) {
        if (err.code === "auth/popup-blocked" || err.code === "auth/popup-closed-by-user") {
          try { await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider()); return; }
          catch (e2) { showMsg($signinMsg, "Sign-in failed: " + e2.message, "error"); }
        } else {
          showMsg($signinMsg, "Sign-in failed: " + err.message, "error");
        }
      }
      $btnSignIn.disabled = false;
      $btnSignIn.textContent = "Sign in with Google";
    }

    function signOut() {
      verifiedUser = false;
      if (dashboardUnsub) { dashboardUnsub(); dashboardUnsub = null; }
      auth.signOut();
    }

    // ── Notifications ─────────────────────────────────────────
    async function enableNotifications() {
      if (!verifiedUser) return;
      if (!messaging) {
        showMsg($actionMsg, "Push notifications not supported in this browser.", "error");
        return;
      }
      if (!VAPID_KEY) {
        await loadVapidKey();
      }
      if (!VAPID_KEY) {
        showMsg($actionMsg, "VAPID key not configured yet.", "error");
        return;
      }
      $btnNotif.disabled = true;
      $btnNotif.textContent = "Requesting...";
      try {
        const perm = await Notification.requestPermission();
        if (perm !== "granted") {
          showMsg($actionMsg, "Permission denied. Enable in browser settings.", "error");
          $btnNotif.disabled = false;
          $btnNotif.textContent = "Enable Notifications";
          return;
        }
        $("notif-pill").className = "pill pill-green";
        $("notif-pill").textContent = "Notifications on";
        await registerToken();
        $btnNotif.textContent = "Notifications On";
        showMsg($actionMsg, "Push notifications enabled!", "success");
      } catch (err) {
        showMsg($actionMsg, "Failed: " + err.message, "error");
        $btnNotif.disabled = false;
        $btnNotif.textContent = "Enable Notifications";
      }
    }

    async function registerToken() {
      if (!verifiedUser) return;
      if (!messaging) return;
      try {
        const reg = await navigator.serviceWorker.register("/firebase-messaging-sw.js");
        const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
        if (!token) return;
        await functions.httpsCallable("registerFcmToken")({
          token,
          deviceInfo: { platform: navigator.platform, userAgent: navigator.userAgent, language: navigator.language }
        });
        $("device-pill").className = "pill pill-green";
        $("device-pill").textContent = "Device registered";

        messaging.onMessage((payload) => {
          const { title, body, icon } = payload.notification || {};
          new Notification(title || "BACKBONE", {
            body: body || "New notification",
            icon: icon || "/icons/icon-192.png",
            data: { url: payload.data?.url }
          });
        });
      } catch (err) {
        console.error("Token registration failed:", err);
      }
    }

    // ── Install PWA ───────────────────────────────────────────
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredInstallPrompt = e;
      if (verifiedUser) $btnInstall.classList.remove("hidden");
    });

    async function installApp() {
      if (!deferredInstallPrompt || !verifiedUser) return;
      deferredInstallPrompt.prompt();
      const r = await deferredInstallPrompt.userChoice;
      if (r.outcome === "accepted") {
        $btnInstall.classList.add("hidden");
        showMsg($actionMsg, "BACKBONE installed!", "success");
      }
      deferredInstallPrompt = null;
    }

    window.addEventListener("appinstalled", () => {
      $btnInstall.classList.add("hidden");
    });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/firebase-messaging-sw.js").catch(() => {});
    }
  </script>
</body>
</html>
